<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>3D 互動課表</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: '微軟正黑體', Arial, sans-serif; background-color: #1a1a2e; }
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            pointer-events: none;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
            transition: opacity 0.3s;
            opacity: 0; /* 預設隱藏，摸到方塊才顯示 */
            max-width: 300px;
        }
        #info h2 { margin: 0 0 10px 0; font-size: 18px; color: #4cc9f0; }
        #info p { margin: 5px 0; font-size: 14px; color: #ddd; }
        
        #instructions {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            color: #888;
            font-size: 12px;
            pointer-events: none;
        }

        /* 讀取動畫 */
        .loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="loading" class="loading">正在建構您的課表城市...</div>

    <div id="info">
        <h2 id="course-name">課程名稱</h2>
        <p><strong>時間:</strong> <span id="course-time"></span></p>
        <p><strong>地點/備註:</strong> <span id="course-note">無</span></p>
    </div>

    <div id="instructions">
        左鍵旋轉 | 右鍵平移 | 滾輪縮放 | 滑鼠懸停查看詳情
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        // --- 1. 資料準備 (將您的 HTML 表格轉換為 JSON) ---
        // 隨機顏色生成器
        function getRandomColor() {
            // 生成鮮明且不過於暗的顏色
            const hue = Math.floor(Math.random() * 360);
            const saturation = Math.floor(Math.random() * 30) + 70; // 70-100%
            const lightness = Math.floor(Math.random() * 20) + 60; // 60-80%
            const color = new THREE.Color(`hsl(${hue}, ${saturation}%, ${lightness}%)`);
            return color.getHex();
        }

        // 課程資料
        const courses = [
            // 星期一 (Day 1)
            { day: 1, start: 4, duration: 3, name: "中文能力與邏輯 AB" },
            { day: 1, start: 10, duration: 2, name: "英語溝通三級 AI" },
            { day: 1, start: 13, duration: 2, name: "實習課" },

            // 星期二 (Day 2)
            { day: 2, start: 4, duration: 3, name: "初階程式設計 AA" },
            { day: 2, start: 9, duration: 3, name: "計算機概論 AA" },

            // 星期三 (Day 3)
            { day: 3, start: 4, duration: 3, name: "金融科技與洗錢防制" },
            { day: 3, start: 7, duration: 2, name: "實習課" },
            { day: 3, start: 9, duration: 3, name: "商用微積分" },

            // 星期四 (Day 4)
            { day: 4, start: 4, duration: 3, name: "會計學原理" },
            { day: 4, start: 9, duration: 3, name: "經濟學原理－個體篇" },
            { day: 4, start: 13, duration: 1, name: "實習課" },

            // 星期五 (Day 5)
            // 體育課合併為一個方塊，從第3節開始，持續2節
            { day: 5, start: 3, duration: 2, name: "體育" }, 
        ].map(course => ({ ...course, color: getRandomColor() })); // 為每門課分配隨機顏色

        // --- 2. Three.js 場景設定 ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a2e); // 深色背景
        scene.fog = new THREE.Fog(0x1a1a2e, 20, 80);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 30, 40); // 設置相機位置

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // 控制器
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.target.set(0, 0, 5); // 讓旋轉中心在課表中段

        // 燈光
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(10, 20, 10);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // --- 3. 建構場景 ---

        // 參數
        const dayWidth = 4;
        const periodHeight = 1.5; // 每節課在Z軸的長度
        const spacing = 0.5;
        const startX = -((5 * dayWidth) + (4 * spacing)) / 2 + (dayWidth/2); // 置中 X
        const startZ = -10; // 起始 Z

        // 地板網格
        const gridHelper = new THREE.GridHelper(60, 60, 0x444444, 0x222222);
        gridHelper.position.y = -0.1;
        scene.add(gridHelper);

        // 標籤產生器 (使用 Canvas 畫文字貼圖)
        function createLabel(text, x, z, fontSize = 60, color = '#ffffff') {
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = color;
            ctx.font = `bold ${fontSize}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);
            
            const texture = new THREE.CanvasTexture(canvas);
            const material = new THREE.MeshBasicMaterial({ map: texture, transparent: true, side: THREE.DoubleSide });
            const geometry = new THREE.PlaneGeometry(dayWidth, dayWidth/2);
            const mesh = new THREE.Mesh(geometry, material);
            mesh.position.set(x, 0.1, z);
            mesh.rotation.x = -Math.PI / 2;
            scene.add(mesh);
        }

        // 繪製星期標籤
        const days = ["Mon", "Tue", "Wed", "Thu", "Fri"];
        days.forEach((day, index) => {
            const x = startX + index * (dayWidth + spacing);
            createLabel(day, x, startZ - 3, 80, '#4cc9f0');
        });

        // 儲存所有課程方塊以便 Raycaster 檢測
        const courseMeshes = [];

        // 建立課程方塊
        courses.forEach(course => {
            // 計算位置
            // X: 根據星期
            const x = startX + (course.day - 1) * (dayWidth + spacing);
            
            // Z: 根據節次 (每節課長度 periodHeight)
            // 課程中心點 = 起始位置 + (開始節次 - 1) * 高度 + (持續節次 * 高度 / 2)
            const z = startZ + ((course.start - 1) * periodHeight) + (course.duration * periodHeight / 2);

            // 幾何體變形 (根據持續時間拉長 Z 軸)
            const geometry = new THREE.BoxGeometry(dayWidth - 0.4, 2, (periodHeight * course.duration) - 0.4);
            
            const material = new THREE.MeshPhysicalMaterial({
                color: course.color,
                transparent: true,
                opacity: 0.9,
                transmission: 0.2, // 玻璃質感
                roughness: 0.1,
                metalness: 0.1,
                clearcoat: 1.0,
            });

            const mesh = new THREE.Mesh(geometry, material);
            
            // 位置調整
            mesh.position.set(x, 1, z); // y=1 因為高度是2，讓它立在地板上
            mesh.castShadow = true;
            mesh.receiveShadow = true;

            // 綁定資料到 Mesh 物件上，方便後續讀取
            mesh.userData = course; 
            
            scene.add(mesh);
            courseMeshes.push(mesh);
        });

        // 移除讀取動畫
        document.getElementById('loading').style.display = 'none';

        // --- 4. 互動邏輯 (Raycaster) ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let intersectedObject = null;
        let originalColor = null;

        const infoDiv = document.getElementById('info');
        const nameEl = document.getElementById('course-name');
        const timeEl = document.getElementById('course-time');

        function onMouseMove(event) {
            // 計算滑鼠位置 (-1 到 +1)
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        }

        window.addEventListener('mousemove', onMouseMove, false);

        // --- 5. 動畫迴圈 ---
        function animate() {
            requestAnimationFrame(animate);

            controls.update();

            // Raycasting 檢測
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(courseMeshes);

            if (intersects.length > 0) {
                const object = intersects[0].object;

                if (intersectedObject !== object) {
                    // 恢復上一個物體的顏色
                    if (intersectedObject) {
                        intersectedObject.material.emissive.setHex(intersectedObject.currentHex);
                        intersectedObject.scale.set(1, 1, 1);
                    }

                    // 紀錄並設定新物體
                    intersectedObject = object;
                    intersectedObject.currentHex = intersectedObject.material.emissive.getHex();
                    
                    // 發光效果
                    intersectedObject.material.emissive.setHex(0x555555);
                    intersectedObject.scale.set(1.05, 1.05, 1.05); // 微微放大

                    // 更新 UI
                    const data = intersectedObject.userData;
                    infoDiv.style.opacity = 1;
                    nameEl.textContent = data.name;
                    nameEl.style.color = '#' + data.color.toString(16); // 使用課程自己的顏色
                    timeEl.textContent = `星期${['','一','二','三','四','五'][data.day]} 第 ${data.start} - ${data.start + data.duration - 1} 節`;
                }
            } else {
                if (intersectedObject) {
                    intersectedObject.material.emissive.setHex(intersectedObject.currentHex);
                    intersectedObject.scale.set(1, 1, 1);
                    intersectedObject = null;
                    infoDiv.style.opacity = 0;
                }
            }

            renderer.render(scene, camera);
        }

        animate();

        // 視窗縮放處理
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
